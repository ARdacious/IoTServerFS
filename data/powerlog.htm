<html>
  <body>
    <div>
      <canvas id="myChart"  width="400px" height="400px"></canvas>
    </div>
    <div id="status">
      status
    </div>
    <div id="connection">
      connection status
    </div>
    <div id="output">
      output
    </div>
    <script src="chart.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script> 


<script>
  var ctx = document.getElementById('myChart').getContext('2d');
  var myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
    },
    options: {
      title: {
        display: true,
        text: 'Temperature'
      },
      responsive:true,
      maintainAspectRatio: false,
      scales: {
        yAxes: [{
          id: 'current',
          type: 'linear',
          position: 'left',
        }, {
          id: 'total',
          type: 'linear',
          position: 'right',
        }]
      }
    }
  });

  var wsUri = 'ws://' + location.hostname + ':81/';
  var output;
  var stat;
  var conn;

  function init()
  {
    output = document.getElementById("output");
    output.hidden = true;
    stat = document.getElementById("status");
    conn = document.getElementById("connection");
    connectWebSocket();
  }

  function connectWebSocket()
  {
    websocket = new WebSocket(wsUri, ['arduino']);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
    conn.textContent = "Initializing connection...";
  }

  function onOpen(evt)
  {
    conn.textContent = "Connected";
    writeToScreen("CONNECTED");
    doSend("WebSocket rocks");
    //document.getElementById("gages").style.display = "";
  }

  function onClose(evt)
  {
    conn.textContent = "Connection closed!";
    writeToScreen("DISCONNECTED");
    //document.getElementById("gages").style.display = "none";
  }

  function onMessage(evt)
  {
    writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>');
    try {
      var colors = ["#3e95cd", "#ff0000", "#00ff00", "#0000ff"];
  		var data = JSON.parse(evt.data);
  		  if (myChart.data.datasets.length <= 0) {
  		    myChart.data.datasets.push({
  		      label:"power",
  		      data:[],
            borderColor: colors[0],
            fill: false,
            pointRadius: 0,
            yAxisID: "current"
  		    });
  		    myChart.data.datasets.push({
  		      label:"gas",
  		      data:[],
            borderColor: colors[1],
            fill: false,
            pointRadius: 0,
            yAxisID: "total"
  		    });
  		    myChart.data.datasets.push({
  		      label:"tarief 1",
  		      data:[],
            borderColor: colors[2],
            fill: false,
            pointRadius: 0,
            yAxisID: "total"
  		    });
  		    myChart.data.datasets.push({
  		      label:"tarief 2",
  		      data:[],
            borderColor: colors[3],
            fill: false,
            pointRadius: 0,
            yAxisID: "total"
  		    });
  		    
  		  }
  		  if (data.hasOwnProperty("power_delivered")) {
          var now = new Date();
          var stamp = now.toLocaleString();
          stat.textContent = "Last message received at: " + stamp;
          myChart.data.labels.push(stamp);
          myChart.data.datasets[0].data.push(data.power_delivered);
          myChart.data.datasets[1].data.push(data.gas_delivered);
          myChart.data.datasets[2].data.push(data.energy_delivered_tariff1);
          myChart.data.datasets[3].data.push(data.energy_delivered_tariff2);
          myChart.update();
  		  }
      
  	}
  	catch (err) {
  		writeToScreen(evt.data);
  		stat.textContent = evt.data;
  	}
  }

  function onError(evt)
  {
    conn.textContent = '<span style="color: red;">ERROR:</span> ' + evt.data;
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
    //document.getElementById("gages").style.display = "none";
  }
  
  function doSend(message)
  {
    writeToScreen("SENT: " + message);
    websocket.send(message);
  }

  function dumpvals()
  {
  	writeToScreen(e.which);
  	var keys = Object.keys(e);
  	writeToScreen(keys);
  	for (let value of Object.keys(e)) {
  		if (typeof e[value] !== 'undefined') {
  			writeToScreen(value + " : jules : " + e[value]);
  		}
  	}
  }
  
  function writeToScreen(message)
  {
  	var pre = document.createElement("p");
  	pre.style.wordWrap = "break-word";
  	pre.innerHTML = message;
  	output.appendChild(pre);
  }

  window.addEventListener("load", init, false);
</script>
</body>
</html>